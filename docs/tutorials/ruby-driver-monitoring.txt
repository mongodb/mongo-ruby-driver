==========
Monitoring
==========

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

The driver allows the application to be notified when certain events happen.
These events are organized into the following categories:

- Command monitoring;
- Topology lifecycle;
- Server lifecycle;
- Server heartbeats.

Topology and server events are part of Server Discovery and Monitoring (SDAM).

Command Monitoring
------------------

All user-initiated commands that are sent to the server publish events that
can be subscribed to for fine grained information. The monitoring API
publishes a guaranteed start event for each command, then either a succeeded
or a failed event. A subscriber must implement 3 methods: ``started``,
``succeeded``, and ``failed``, each which takes a single parameter for
the event. The following is an example logging subscriber based on a
logging subscriber used internally by the driver:

.. code-block:: ruby

  class CommandLogSubscriber
    include Mongo::Loggable

    def started(event)
      log_debug("#{prefix(event)} | STARTED | #{format_command(event.command)}")
    end

    def succeeded(event)
      log_debug("#{prefix(event)} | SUCCEEDED | #{event.duration}s")
    end

    def failed(event)
      log_debug("#{prefix(event)} | FAILED | #{event.message} | #{event.duration}s")
    end

    private

    def logger
      Mongo::Logger.logger
    end

    def format_command(args)
      begin
        args.inspect
      rescue Exception
        '<Unable to inspect arguments>'
      end
    end

    def format_message(message)
      format("COMMAND | %s".freeze, message)
    end

    def prefix(event)
      "#{event.address.to_s} | #{event.database_name}.#{event.command_name}"
    end
  end

To register a custom subscriber, you can do so globally for
all clients or on a per-client basis:

.. code-block:: ruby

  subscriber = CommandLogSubscriber.new

  Mongo::Monitoring::Global.subscribe(Mongo::Monitoring::COMMAND, subscriber)

  client = Mongo::Client.new([ '127.0.0.1:27017' ], :database => 'test' )
  client.subscribe( Mongo::Monitoring::COMMAND, subscriber )

Sample output:

  D, [2018-09-23T13:47:31.258020 #4692] DEBUG -- : COMMAND | 127.0.0.1:27027 | test.ismaster | STARTED | {"ismaster"=>1, "$readPreference"=>{"mode"=>"primary"}, "lsid"=>{"id"=><BSON::Binary:0x47111693353080 type=uuid data=0x730341e880dc40a2...>}}
  D, [2018-09-23T13:47:31.259145 #4692] DEBUG -- : COMMAND | 127.0.0.1:27027 | test.ismaster | SUCCEEDED | 0.000791175s


Server Heartbeats
-----------------

The application can be notified of each server heartbeat by subscribing
to SERVER_HEARTBEAT topic. A server heartbeat listener must implement
three methods: `started`, `succeeded` and `failed`. Each heartbeat invokes
the `started` method on the listener, and then either `succeeded` or `failed`
method depending on the outcome of the heartbeat.

All heartbeat events contain the address of the server that the heartbeat
was sent to. Succeeded and failed events contain the round trip time for
the ismaster command. Failed event also contains the exception instance that
was raised during ismaster command execution. Please review the API
documentation for ServerHeartbeatStarted, ServerHeartbeatSucceeded and
ServerHeartbeatFailed for event attribute details.

The following is an example logging heartbeat event subscriber:

.. code-block:: ruby

  class HeartbeatLogSubscriber
    include Mongo::Loggable

    def started(event)
      log_debug("#{event.address} | STARTED")
    end

    def succeeded(event)
      log_debug("#{event.address} | SUCCEEDED | #{event.duration}s")
    end

    def failed(event)
      log_debug("#{event.address} | FAILED | #{event.error.class}: #{event.error.message} | #{event.duration}s")
    end
    
    private
    
    def logger
      Mongo::Logger.logger
    end

    def format_message(message)
      format("HEARTBEAT | %s".freeze, message)
    end
  end

Similarly to command events, the application can subscribe to heartbeat
events globally or for a specific client:

.. code-block:: ruby

  subscriber = HeartbeatLogSubscriber.new

  Mongo::Monitoring::Global.subscribe(Mongo::Monitoring::SERVER_HEARTBEAT, subscriber)

  client = Mongo::Client.new([ '127.0.0.1:27017' ], :database => 'test' )
  client.subscribe( Mongo::Monitoring::SERVER_HEARTBEAT, subscriber )

Sample output:

D, [2018-09-23T13:44:10.707018 #1739] DEBUG -- : HEARTBEAT | 127.0.0.1:27027 | STARTED
D, [2018-09-23T13:44:10.707778 #1739] DEBUG -- : HEARTBEAT | 127.0.0.1:27027 | SUCCEEDED | 0.000772381s


Disabling Monitoring
--------------------

To turn off monitoring, set the client monitoring option to ``false``:

.. code-block:: ruby

  client = Mongo::Client.new([ '127.0.0.1:27017' ], :database => 'test', :monitoring => false )
