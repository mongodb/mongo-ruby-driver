database_name: &database_name "ruby-driver"
collection_name: &collection_name "test"

data: []

# These tests use error codes where the TransientTransactionError label will be
# applied to the error response for commitTransaction. This will cause the
# entire transaction to be retried instead of commitTransaction.
#
# See: https://github.com/mongodb/mongo/blob/r4.1.6/src/mongo/db/handle_request_response.cpp
tests:
  -
    description: transaction is retried commitTransaction TransientTransactionError (NotMaster)
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["commitTransaction"]
          errorCode: 10107 # NotMaster
          closeConnection: false
    operations:
      -
        name: withTransaction
        object: session0
        callback: &callback
          operations:
            -
              name: insertOne
              object: collection
              arguments:
                session: session0
                document: { _id: 1 }
              result:
                insertedId: 1
        result:
          errorCodeName: NotMaster
          errorLabelsContain: ["TransientTransactionError"]
          errorLabelsOmit: ["UnknownTransactionCommitResult"]
    expectations: &expectations
      -
        command_started_event:
          command:
            insert: *collection_name
            documents:
              - { _id: 1 }
            ordered: true
            lsid: session0
            txnNumber: { $numberLong: "1" }
            startTransaction: true
            autocommit: false
            # omitted fields
            readConcern: ~
            writeConcern: ~
          command_name: insert
          database_name: *database_name
      -
        command_started_event:
          command:
            commitTransaction: 1
            lsid: session0
            txnNumber: { $numberLong: "1" }
            autocommit: false
            # omitted fields
            readConcern: ~
            startTransaction: ~
            writeConcern: ~
          command_name: commitTransaction
          database_name: admin
      -
        command_started_event:
          command:
            insert: *collection_name
            documents:
              - { _id: 1 }
            ordered: true
            lsid: session0
            # txnNumber is incremented when retrying the transaction
            txnNumber: { $numberLong: "2" }
            startTransaction: true
            autocommit: false
            # omitted fields
            readConcern: ~
            writeConcern: ~
          command_name: insert
          database_name: *database_name
      -
        command_started_event:
          command:
            commitTransaction: 1
            lsid: session0
            txnNumber: { $numberLong: "2" }
            autocommit: false
            # omitted fields
            readConcern: ~
            startTransaction: ~
            writeConcern: ~
          command_name: commitTransaction
          database_name: admin
    outcome: &outcome
      collection:
        data:
          - { _id: 1 }
  -
    description: transaction is retried commitTransaction TransientTransactionError (LockTimeout)
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["commitTransaction"]
          errorCode: 24 # SnapshotUnavailable
          closeConnection: false
    operations:
      -
        name: withTransaction
        object: session0
        callback: *callback
        result:
          errorCodeName: LockTimeout
          errorLabelsContain: ["TransientTransactionError"]
          errorLabelsOmit: ["UnknownTransactionCommitResult"]
    expectations: *expectations
    outcome: *outcome
  -
    description: transaction is retried commitTransaction TransientTransactionError (WriteConflict)
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["commitTransaction"]
          errorCode: 112 # WriteConflict
          closeConnection: false
    operations:
      -
        name: withTransaction
        object: session0
        callback: *callback
        result:
          errorCodeName: WriteConflict
          errorLabelsContain: ["TransientTransactionError"]
          errorLabelsOmit: ["UnknownTransactionCommitResult"]
    expectations: *expectations
    outcome: *outcome
  -
    description: transaction is retried commitTransaction TransientTransactionError (SnapshotUnavailable)
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["commitTransaction"]
          errorCode: 246 # SnapshotUnavailable
          closeConnection: false
    operations:
      -
        name: withTransaction
        object: session0
        callback: *callback
        result:
          errorCodeName: SnapshotUnavailable
          errorLabelsContain: ["TransientTransactionError"]
          errorLabelsOmit: ["UnknownTransactionCommitResult"]
    expectations: *expectations
    outcome: *outcome
  -
    description: transaction is retried commitTransaction TransientTransactionError (NoSuchTransaction)
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["commitTransaction"]
          errorCode: 251 # NoSuchTransaction
          closeConnection: false
    operations:
      -
        name: withTransaction
        object: session0
        callback: *callback
        result:
          errorCodeName: NoSuchTransaction
          errorLabelsContain: ["TransientTransactionError"]
          errorLabelsOmit: ["UnknownTransactionCommitResult"]
    expectations: *expectations
    outcome: *outcome
  -
    description: transaction is retried commitTransaction TransientTransactionError (PreparedTransactionInProgress)
    failPoint:
      configureFailPoint: failCommand
      mode: { times: 1 }
      data:
          failCommands: ["commitTransaction"]
          errorCode: 267 # PreparedTransactionInProgress
          closeConnection: false
    operations:
      -
        name: withTransaction
        object: session0
        callback: *callback
        result:
          errorCodeName: PreparedTransactionInProgress
          errorLabelsContain: ["TransientTransactionError"]
          errorLabelsOmit: ["UnknownTransactionCommitResult"]
    expectations: *expectations
    outcome: *outcome
